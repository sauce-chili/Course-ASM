  format PE GUI 4.0                                                ; 32-????????? ??????? ?????????? WINDOWS EXE
entry start                                                      ; ????? ?????

include '_include/win32a.inc'

ID_MESSAGE = 102                                                 ; ?????????????? ????????? ????? ????? ? ??????
ID_OK = 104
ID_CANCEL = 105
ID_MESSAGE2 = 103
section '.text' code readable executable                         ; ?????? ????

  start:
        invoke GetModuleHandle,0                                     ; ???????? ?????????? ????????????? ????????? ???????????? ??????
        invoke DialogBoxParam,eax,0,HWND_DESKTOP,DialogProc,0        ; ????????? ???? ????????? ????????? ??? ????????? ???????????? ??????
        or eax,eax                                                   ; ???? ?????? ?????? 1 ??...
        jz exit
        invoke MessageBox,HWND_DESKTOP,value,caption,MB_ICONWARNING             ; ...??????? ?????????
  exit:
        invoke ExitProcess,0                                         ; ????????? ?????????? ?????????

proc DialogProc hwnddlg,msg,wparam,lparam                        ; ??????? ??????? ????????? ?????????
        push ebx esi edi ecx
        cmp     [msg],WM_INITDIALOG                                      ; ????????? ?????????????? ?????????? ????
        je      .wminitdialog
        cmp     [msg],WM_COMMAND                                         ; ????????? ???????????? ??? ??????? ?? ??????, ???? ? ?.?.
        je      .wmcommand
        cmp     [msg],WM_CLOSE                                           ; ????????? ???????????? ????? ????????? ????
        je      .wmclose
        xor     eax,eax                                                  ; ???? ????????? ?? ?????????? ?????????? 0
        jmp     .finish
  .wminitdialog:
        jmp     .processed
  .wmcommand:
        cmp     [wparam],BN_CLICKED shl 16 + ID_CANCEL                   ; ???? ?????? ?????? CANCEL
        je      .wmclose
        cmp     [wparam],BN_CLICKED shl 16 + ID_OK                       ; ???? ?????? ?????? OK
        jne     .processed


       invoke GetDlgItemText,[hwnddlg],ID_MESSAGE,message,100h

       invoke GetDlgItemText,[hwnddlg],ID_MESSAGE2,message2,100h

       invoke atoi, message   ; полечение знчение из первого текстового поля
       mov [count_1], eax
       invoke atoi, message2  ; получение значения из второго текстового поля
       add eax, [count_1]

       invoke itoa,eax,value, 10
       invoke EndDialog,[hwnddlg], 1                                ; отображаем результат в финальном окне
       jmp     .processed
  .wmclose:
        invoke EndDialog,[hwnddlg],0                                 ; закрыть окно
  .processed:
        mov     eax, 1                                                    ; завершаем работу программыъ
  .finish:
        pop     ecx edi esi ebx                                         ; освобождаем используемые регистры
        ret
endp

section '.bss' readable writeable                                ; ?????? ??????

  caption db "Result",0                                                 ; ?????? ??? ???????? ????????? ? ?????????
  message dd 1000000h    ;rb
  message2 dd 1000000h ; new
  value dd 0
  count_1 dd 0
  count_2 dd -1
section '.idata' import data readable writeable                  ; ?????? ????????????? ???????

  library kernel,'KERNEL32.DLL',\
          user,'USER32.DLL',\
          msvcrt,'msvcrt.dll'

  import kernel,\
         GetModuleHandle,'GetModuleHandleA',\
         ExitProcess,'ExitProcess'

  import user,\
         DialogBoxParam,'DialogBoxParamA',\
         GetDlgItemText,'GetDlgItemTextA',\
         GetDlgItemInt,'GetDlgItemInt',\
         MessageBox,'MessageBoxA',\
         EndDialog,'EndDialog'

  import msvcrt,\
         strlen,'strlen',\
         itoa,'_itoa',\
         atoi, 'atoi'


section '.rsrc' resource data readable

  directory RT_DIALOG,dialogs

  resource dialogs,0,LANG_ENGLISH+SUBLANG_DEFAULT,demonstration

  dialog demonstration,'lab 6 Burdenyuk',350,250,430,65,WS_CAPTION+WS_POPUP+WS_SYSMENU+DS_MODALFRAME
    dialogitem 'STATIC','&Enter string:',-1,10,5,70,8,WS_VISIBLE
    dialogitem 'EDIT','',ID_MESSAGE,10,5,410,13,WS_VISIBLE+WS_BORDER+WS_TABSTOP+ES_AUTOHSCROLL
    dialogitem 'EDIT','',ID_MESSAGE2,10,20,410,13,WS_VISIBLE+WS_BORDER+WS_TABSTOP+ES_AUTOHSCROLL
    dialogitem 'BUTTON','OK',ID_OK,10,40,200,15,WS_VISIBLE+WS_TABSTOP+BS_DEFPUSHBUTTON
    dialogitem 'BUTTON','Cancel',ID_CANCEL,220,40,200,15,WS_VISIBLE+WS_TABSTOP+BS_PUSHBUTTON
  enddialog